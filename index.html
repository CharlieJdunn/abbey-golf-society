<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abbey Golf Society</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --augusta-950:#07140e;
      --augusta-900:#0b1f16;
      --augusta-800:#0f2d22;
      --augusta-700:#144232;
      --augusta-600:#1b5a43;
      --paper:#f7f6f1;
    }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .serif { font-family: "Playfair Display", Georgia, serif; }
    :focus-visible{ outline: 3px solid rgba(27,90,67,.35); outline-offset: 2px; border-radius: 16px; }
    .tabular-nums{ font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="bg-[var(--paper)] text-slate-900 min-h-screen">
  <!-- Header -->
  <div class="sticky top-0 z-20 border-b border-black/5 bg-[var(--paper)]/85 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="#home" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl border border-black/10 bg-white shadow-sm flex items-center justify-center overflow-hidden">
          <img src="./assets/logo.png" alt="Abbey Golf Society" class="h-8 w-8 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='üèÜ';" />
        </div>
        <div class="leading-tight">
          <div class="font-semibold tracking-tight">Abbey Golf Society</div>
          <div class="text-xs text-slate-600">Fixtures ¬∑ Standings ¬∑ Results</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <nav class="hidden sm:flex items-center gap-2">
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#home">Home</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#leaderboard">Leaderboard</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#rounds">Rounds</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#members">Members</a>
        </nav>

        <a id="adminLink"
           class="px-4 py-2 rounded-2xl bg-[var(--augusta-800)] text-white font-medium shadow-sm hover:bg-[var(--augusta-700)] border border-black/10"
           target="_blank" rel="noopener">
          Admin
        </a>
      </div>
    </div>

    <div class="sm:hidden border-t border-black/5 bg-[var(--paper)]/70">
      <div class="max-w-6xl mx-auto px-4 py-2 flex gap-2 overflow-x-auto">
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#home">Home</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#leaderboard">Leaderboard</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#rounds">Rounds</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#members">Members</a>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- Slim Hero -->
    <section class="rounded-3xl border border-black/10 overflow-hidden shadow-sm bg-white">
      <div class="bg-gradient-to-br from-[var(--augusta-950)] via-[var(--augusta-900)] to-[var(--augusta-800)] text-white">
        <div class="px-5 py-6 sm:py-7">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-2xl bg-white/10 border border-white/15 shadow flex items-center justify-center overflow-hidden">
                <img src="./assets/logo.png" alt="Abbey Golf Society logo" class="w-full h-full object-contain p-2" onerror="this.style.display='none';" />
              </div>
              <div>
                <h1 class="serif text-2xl sm:text-3xl font-bold tracking-tight">Abbey Golf Society</h1>
                <p id="seasonLabel" class="text-white/80 text-sm mt-1">Season</p>
              </div>
            </div>

            <div class="hidden sm:flex items-center gap-2">
              <a href="#leaderboard" class="px-4 py-2 rounded-2xl bg-white text-[var(--augusta-900)] font-medium hover:bg-white/90">
                View standings
              </a>
              <button id="btnRefreshTop" class="px-4 py-2 rounded-2xl bg-white/10 border border-white/20 hover:bg-white/15 text-white">
                Refresh
              </button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-3 gap-2 sm:max-w-md">
            <div class="rounded-2xl border border-white/15 bg-white/10 px-3 py-2 text-center">
              <div class="text-xs text-white/70">Members</div>
              <div id="statMembers" class="font-semibold tabular-nums">‚Äî</div>
            </div>
            <div class="rounded-2xl border border-white/15 bg-white/10 px-3 py-2 text-center">
              <div class="text-xs text-white/70">Rounds</div>
              <div id="statRounds" class="font-semibold tabular-nums">‚Äî</div>
            </div>
            <div class="rounded-2xl border border-white/15 bg-white/10 px-3 py-2 text-center">
              <div class="text-xs text-white/70">Results</div>
              <div id="statResults" class="font-semibold tabular-nums">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section id="pageHome" class="page space-y-6">
      <!-- Upcoming first -->
      <section class="bg-white rounded-3xl shadow-sm p-6 border border-black/10">
        <div class="flex items-center justify-between">
          <h2 class="serif text-xl font-bold">Upcoming Round</h2>
          <span class="text-xs px-3 py-1 rounded-2xl bg-[var(--paper)] border border-black/10 text-slate-600">Next</span>
        </div>

        <div class="mt-4 grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <div id="upTitle" class="text-2xl font-bold text-[var(--augusta-900)]">‚Äî</div>
            <div id="upWhen" class="text-slate-600 mt-1">‚Äî</div>
            <div id="upWhere" class="mt-3 text-slate-800">‚Äî</div>
            <div id="upFormat" class="text-slate-800 mt-1">‚Äî</div>
            <div id="upNotes" class="mt-3 text-sm text-slate-600">‚Äî</div>
          </div>

          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-600">Quick actions</div>
            <div class="mt-3 flex gap-2">
              <a href="#rounds" class="flex-1 text-center px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm">Rounds</a>
              <a href="#leaderboard" class="flex-1 text-center px-3 py-2 rounded-2xl bg-[var(--augusta-800)] text-white hover:bg-[var(--augusta-700)] text-sm">Standings</a>
            </div>

            <div class="mt-4 text-xs text-slate-500">
              Leaderboard totals are the <span class="font-semibold">sum of Stableford points</span> across all rounds.
              Handicaps update <span class="font-semibold">sequentially</span> after each round.
            </div>

            <div class="mt-4">
              <div class="text-xs text-slate-600">Search</div>
              <div class="mt-2 flex gap-2">
                <input id="searchBox" class="w-full rounded-2xl border border-black/10 px-4 py-2 bg-white" placeholder="Search players‚Ä¶" />
                <button id="btnReset" class="px-4 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Full standings on home (mobile-first cards + desktop table) -->
      <section class="bg-white rounded-3xl shadow-sm p-6 border border-black/10">
        <div class="flex items-end justify-between gap-4">
          <div>
            <h2 class="serif text-xl font-bold">Leaderboard</h2>
            <p class="text-sm text-slate-600 mt-1">Total = sum of round Stableford points.</p>
          </div>
          <a href="#leaderboard" class="text-sm px-4 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 hidden sm:inline-flex">Open full</a>
        </div>

        <div id="lbCardsHome" class="mt-5 grid gap-3 sm:hidden"></div>

        <div class="mt-5 rounded-2xl border border-black/10 overflow-hidden hidden sm:block">
          <table class="w-full text-left">
            <thead class="bg-[var(--augusta-900)] text-white">
              <tr class="text-sm">
                <th class="p-3 w-10">#</th>
                <th class="p-3">Player</th>
                <th class="p-3 text-right">Total</th>
                <th class="p-3 text-right">Played</th>
                <th class="p-3 text-right">Wins</th>
                <th class="p-3 text-right">Top-3</th>
                <th class="p-3 text-right">Hcap</th>
              </tr>
            </thead>
            <tbody id="lbTableHome" class="divide-y divide-black/5"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- LEADERBOARD -->
    <section id="pageLeaderboard" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Leaderboard</h2>
      <p class="text-sm text-slate-600">Ranked by total Stableford points (sum of all rounds).</p>

      <div id="lbCards" class="grid gap-3 sm:hidden"></div>

      <div class="bg-white rounded-2xl shadow-sm border border-black/10 overflow-hidden hidden sm:block">
        <table class="w-full text-left">
          <thead class="bg-[var(--augusta-900)] text-white">
            <tr class="text-sm">
              <th class="p-3 w-10">#</th>
              <th class="p-3">Player</th>
              <th class="p-3 text-right">Total</th>
              <th class="p-3 text-right">Played</th>
              <th class="p-3 text-right">Wins</th>
              <th class="p-3 text-right">Top-3</th>
              <th class="p-3 text-right">Current Hcap</th>
            </tr>
          </thead>
          <tbody id="lbTable" class="divide-y divide-black/5"></tbody>
        </table>
      </div>
    </section>

    <!-- ROUNDS -->
    <section id="pageRounds" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Rounds</h2>
      <p class="text-sm text-slate-600">Each round is ranked from Stableford score. Tap a member to see handicap progression.</p>
      <div id="roundsGrid" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- MEMBERS -->
    <section id="pageMembers" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Members</h2>
      <p class="text-sm text-slate-600">Tap a member to see their round-by-round points and handicap changes.</p>
      <div id="membersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- Footer status -->
    <footer class="py-10 text-center space-y-3">
      <div class="text-xs text-slate-500">¬© 2026 Abbey Golf Society</div>

      <div class="inline-flex flex-col sm:flex-row sm:items-center gap-2 justify-center text-xs">
        <div class="px-3 py-2 rounded-2xl border border-black/10 bg-white">
          <span id="statusLine" class="font-semibold">Ready</span>
          <span class="text-slate-500">¬∑</span>
          <span id="statusDetail" class="text-slate-500">‚Äî</span>
        </div>
        <button id="btnRefresh" class="px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5">
          Refresh
        </button>
      </div>
    </footer>
  </main>

  <!-- MEMBER MODAL -->
  <div id="memberModal" class="fixed inset-0 hidden items-end sm:items-center justify-center bg-black/40 p-3 z-50">
    <div class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl border border-black/10 overflow-hidden">
      <div class="px-5 py-4 border-b border-black/10 flex items-center justify-between gap-3">
        <div>
          <div class="text-xs text-slate-500">Member</div>
          <div id="mmName" class="serif text-xl font-bold text-[var(--augusta-900)]">‚Äî</div>
          <div id="mmRole" class="text-sm text-slate-600">‚Äî</div>
        </div>
        <button id="mmClose" class="px-3 py-2 rounded-2xl border border-black/10 hover:bg-black/5">Close</button>
      </div>

      <div class="p-5 space-y-5">
        <div class="grid sm:grid-cols-3 gap-3">
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Total Points</div>
            <div id="mmTotal" class="text-2xl font-bold tabular-nums mt-1">‚Äî</div>
          </div>
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Current Handicap</div>
            <div id="mmHcap" class="text-2xl font-bold tabular-nums mt-1">‚Äî</div>
          </div>
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Handicap Trend</div>
            <div class="mt-2">
              <svg id="mmSpark" viewBox="0 0 120 36" class="w-full h-9">
                <polyline id="mmSparkLine" fill="none" stroke="rgba(27,90,67,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points=""></polyline>
              </svg>
              <div id="mmSparkHint" class="text-xs text-slate-500 mt-1">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border border-black/10 overflow-hidden">
          <div class="px-4 py-3 bg-[var(--augusta-900)] text-white text-sm font-semibold">Round-by-round points & handicap updates</div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-white">
                <tr class="text-xs text-slate-500">
                  <th class="p-3">Round</th>
                  <th class="p-3">Course</th>
                  <th class="p-3 text-right">Pts</th>
                  <th class="p-3 text-right">Band</th>
                  <th class="p-3 text-right">Adj</th>
                  <th class="p-3 text-right">New Hcap</th>
                </tr>
              </thead>
              <tbody id="mmBody" class="divide-y divide-black/5"></tbody>
            </table>
          </div>
        </div>

        <div class="text-xs text-slate-500">
          This is calculated sequentially: your score in a round updates your handicap, which affects your band + adjustment in the next round.
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SHEET_ID = "1jFLU54LLj3RMcdWIeKOMz8UO8HuWbAXm8ZzhRGeFjUk";
    const SHEET_URL = (tab) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;
    document.getElementById("adminLink").href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?usp=sharing`;

    const $ = (id) => document.getElementById(id);

    function setStatus(line, detail="") {
      $("statusLine").textContent = line;
      $("statusDetail").textContent = detail || "‚Äî";
    }

    // =========================
    // CSV parser
    // =========================
    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0; i<text.length; i++) {
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }
        if (!inQuotes && ch === "\n") { row.push(cur); rows.push(row); row = []; cur = ""; continue; }
        if (ch !== "\r") cur += ch;
      }
      row.push(cur);
      rows.push(row);

      return rows.filter(r => r.some(c => String(c).trim() !== ""));
    }

    function toObjects(rows) {
      if (!rows.length) return [];
      const headers = rows[0].map(h => String(h).trim());
      return rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h, i) => o[h] = r[i] ?? "");
        return o;
      }).filter(o => Object.values(o).some(v => String(v).trim() !== ""));
    }

    async function fetchTab(tab) {
      const res = await fetch(SHEET_URL(tab), { cache: "no-store" });
      if (!res.ok) throw new Error(`${tab} fetch failed (${res.status})`);
      const text = await res.text();
      return toObjects(parseCSV(text));
    }

    // =========================
    // Normalisers (prevents the "not updating" issues)
    // =========================
    function normName(s){
      return String(s ?? "")
        .trim()
        .replace(/[‚Äô‚Äò]/g, "'")     // smart apostrophes -> normal
        .replace(/\s+/g, " ");     // collapse spaces
    }
    function normRoundId(s){
      return String(s ?? "").trim().toUpperCase();
    }
    function toNumOrNull(v){
      if (v == null) return null;
      const x = String(v).trim();
      if (!x) return null;
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }
    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
    }
    function round1(n){ return Math.round((Number(n)+Number.EPSILON)*10)/10; }

    // =========================
    // Handicap rules
    // =========================
    let adjLookup = new Map(); // key: band:score -> adjustment

    // Your band rules (from earlier):
    // Band 4: 29+, Band 3: 20‚Äì28, Band 2: 11‚Äì19, Band 1: 0‚Äì10
    function bandFromHandicap(h) {
      const x = Math.round(Number(h) || 0);
      if (x >= 29) return 4;
      if (x >= 20) return 3;
      if (x >= 11) return 2;
      return 1;
    }

    function getAdj(currentHcap, stablefordPoints) {
      const band = bandFromHandicap(currentHcap);
      const score = Math.trunc(Number(stablefordPoints));
      const k = `${band}:${score}`;
      const adj = adjLookup.get(k);
      return { band, adj: (typeof adj === "number" ? adj : 0) };
    }

    // =========================
    // Routing
    // =========================
    const ROUTES = { home:"pageHome", leaderboard:"pageLeaderboard", rounds:"pageRounds", members:"pageMembers" };
    function showPage() {
      const hash = (location.hash || "#home").slice(1).toLowerCase();
      const pageId = ROUTES[hash] || ROUTES.home;
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      $(pageId).classList.remove("hidden");
    }

    // =========================
    // Data model
    // =========================
    let DATA = {
      members: [],
      rounds: [],
      results: [],
      config: []
    };

    function getCfg() {
      return Object.fromEntries((DATA.config || []).map(x => [x.key, x.value]));
    }

    function resultsForRound(roundId){
      const rid = normRoundId(roundId);
      return (DATA.results || []).filter(r => r.roundId === rid && r.name);
    }

    function buildRoundRanks() {
      // For each round, rank members from Stableford points (desc), ties share position.
      // DNP (null/0) excluded.
      const map = new Map(); // roundId -> { ranked: [{name, pts, pos}], posByName: Map }
      for (const r of (DATA.rounds || [])) {
        const rid = r.id;
        const items = resultsForRound(rid)
          .map(x => ({ name: x.name, pts: x.stablefordPoints }))
          .filter(x => x.pts != null && Number(x.pts) > 0);

        items.sort((a,b) => (b.pts - a.pts) || a.name.localeCompare(b.name));

        const ranked = [];
        let lastPts = null;
        let lastPos = 0;
        for (let i=0; i<items.length; i++) {
          const it = items[i];
          const pos = (lastPts === it.pts) ? lastPos : (i + 1);
          ranked.push({ ...it, pos });
          lastPts = it.pts;
          lastPos = pos;
        }

        const posByName = new Map(ranked.map(x => [x.name, x.pos]));
        map.set(rid, { ranked, posByName });
      }
      return map;
    }

    function computeHandicapHistoryAndCurrent() {
      // Sequential handicap updates per player across rounds by date order.
      const roundsSorted = (DATA.rounds || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
      const resultByRound = new Map();
      for (const r of roundsSorted) {
        resultByRound.set(r.id, resultsForRound(r.id));
      }

      const current = new Map();
      const history = new Map(); // name -> array of steps

      for (const m of (DATA.members || [])) {
        const start = round1(toNumOrNull(m.startHandicapIndex) ?? 0);
        current.set(m.name, start);
        history.set(m.name, [{
          roundId: null,
          roundLabel: "Start",
          course: "‚Äî",
          pts: null,
          band: bandFromHandicap(start),
          adj: null,
          newHcap: start
        }]);
      }

      for (const r of roundsSorted) {
        const res = resultByRound.get(r.id) || [];
        for (const m of (DATA.members || [])) {
          const cur = current.get(m.name);
          const row = res.find(x => x.name === m.name);
          const pts = row ? row.stablefordPoints : null;

          if (pts == null || Number(pts) <= 0) {
            // DNP -> no change, but we still record the round (optional).
            history.get(m.name).push({
              roundId: r.id,
              roundLabel: r.id,
              course: r.course || "",
              pts: null,
              band: bandFromHandicap(cur),
              adj: null,
              newHcap: cur
            });
            continue;
          }

          const out = getAdj(cur, pts);
          const next = Math.max(0, round1(cur + out.adj));
          current.set(m.name, next);

          history.get(m.name).push({
            roundId: r.id,
            roundLabel: r.id,
            course: r.course || "",
            pts: Number(pts),
            band: out.band,
            adj: out.adj,
            newHcap: next
          });
        }
      }

      return { currentHcap: current, history };
    }

    function computeLeaderboard(searchText="") {
      const rankMap = buildRoundRanks();
      const { currentHcap } = computeHandicapHistoryAndCurrent();

      // totals from stableford points
      const totals = new Map(); // name -> { total, played, wins, top3 }
      for (const m of (DATA.members || [])) {
        totals.set(m.name, { name: m.name, role: m.role || "Member", total: 0, played: 0, wins: 0, top3: 0 });
      }

      for (const r of (DATA.rounds || [])) {
        const rr = rankMap.get(r.id);
        if (!rr) continue;

        for (const item of rr.ranked) {
          const t = totals.get(item.name);
          if (!t) continue;
          t.total += Number(item.pts);
          t.played += 1;
          if (item.pos === 1) t.wins += 1;
          if (item.pos <= 3) t.top3 += 1;
        }
      }

      let rows = Array.from(totals.values()).map(x => ({
        ...x,
        total: Math.round(x.total), // stableford are ints
        handicapIndex: currentHcap.get(x.name) ?? (toNumOrNull(DATA.members.find(m=>m.name===x.name)?.startHandicapIndex) ?? 0)
      }));

      const q = String(searchText || "").trim().toLowerCase();
      if (q) rows = rows.filter(r => r.name.toLowerCase().includes(q));

      rows.sort((a,b) => (b.total - a.total) || (b.wins - a.wins) || a.name.localeCompare(b.name));
      return rows.map((r,i) => ({ rank: i+1, ...r }));
    }

    // =========================
    // UI rendering
    // =========================
    function lbCard(r){
      return `
        <div class="rounded-2xl border border-black/10 bg-white p-4 shadow-sm">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-slate-500">#${r.rank}</div>
              <div class="font-semibold text-[var(--augusta-900)]">${escapeHtml(r.name)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(r.role)}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Total</div>
              <div class="text-2xl font-bold tabular-nums">${r.total}</div>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Played</div>
              <div class="font-semibold tabular-nums">${r.played}</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Wins</div>
              <div class="font-semibold tabular-nums">${r.wins}</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Hcap</div>
              <div class="font-semibold tabular-nums">${r.handicapIndex}</div>
            </div>
          </div>
        </div>
      `;
    }

    function lbRow(r){
      return `
        <tr class="border-t border-black/5 ${r.rank===1 ? "bg-[rgba(27,90,67,.07)]" : ""}">
          <td class="p-3 font-semibold">${r.rank}</td>
          <td class="p-3">
            <div class="font-medium">${escapeHtml(r.name)}</div>
            <div class="text-xs text-slate-500">${escapeHtml(r.role)}</div>
          </td>
          <td class="p-3 text-right font-semibold tabular-nums">${r.total}</td>
          <td class="p-3 text-right tabular-nums">${r.played}</td>
          <td class="p-3 text-right tabular-nums">${r.wins}</td>
          <td class="p-3 text-right tabular-nums">${r.top3}</td>
          <td class="p-3 text-right tabular-nums">${r.handicapIndex}</td>
        </tr>
      `;
    }

    function roundCard(round, rankMap){
      const rr = rankMap.get(round.id);
      const top3 = rr ? rr.ranked.slice(0,3) : [];
      const winner = top3[0];

      const topHtml = top3.length ? top3.map(x => `
        <li class="flex items-center justify-between gap-3">
          <span class="text-slate-800">#${x.pos} ${escapeHtml(x.name)}</span>
          <span class="text-slate-500 text-xs tabular-nums">${x.pts} pts</span>
        </li>
      `).join("") : `<li class="text-slate-500">No results yet.</li>`;

      return `
        <div class="bg-white rounded-2xl shadow-sm border border-black/10 p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-bold text-[var(--augusta-900)]">${escapeHtml(round.course || "‚Äî")}</div>
              <div class="text-slate-600 text-sm">${escapeHtml(round.date || "")} ‚Ä¢ ${escapeHtml(round.format || "Stableford")}</div>
            </div>
            <span class="text-xs px-3 py-1 rounded-2xl bg-[var(--paper)] border border-black/10 text-slate-600">${escapeHtml(round.id)}</span>
          </div>

          <div class="mt-4 rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Winner</div>
            <div class="font-semibold mt-1">
              ${winner ? `${escapeHtml(winner.name)} <span class="text-slate-500">(${winner.pts} pts)</span>` : `<span class="text-slate-500">‚Äî</span>`}
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs text-slate-500 font-semibold uppercase tracking-wide">Top 3</div>
            <ul class="mt-2 space-y-2 text-sm">${topHtml}</ul>
          </div>
        </div>
      `;
    }

    // =========================
    // Member Modal
    // =========================
    function sparkPoints(values, w=120, h=36, pad=6) {
      if (!values || values.length < 2) return "";
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;
      const xStep = (w - pad*2) / (values.length - 1);
      return values.map((v, i) => {
        const x = pad + i * xStep;
        const y = pad + (h - pad*2) * (1 - ((v - min) / range));
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
    }

    function openMemberModal(name) {
      const nm = normName(name);
      const member = (DATA.members || []).find(m => m.name === nm);
      if (!member) return;

      const league = computeLeaderboard($("searchBox")?.value || "");
      const row = league.find(r => r.name === nm);

      const { currentHcap, history } = computeHandicapHistoryAndCurrent();
      const hist = history.get(nm) || [];
      const cur = currentHcap.get(nm) ?? toNumOrNull(member.startHandicapIndex) ?? 0;

      $("mmName").textContent = nm;
      $("mmRole").textContent = member.role || "Member";
      $("mmTotal").textContent = row ? row.total : "0";
      $("mmHcap").textContent = String(cur);

      // sparkline values (handicap after each step)
      const vals = hist.map(x => Number(x.newHcap)).filter(v => Number.isFinite(v));
      $("mmSparkLine").setAttribute("points", sparkPoints(vals));
      $("mmSparkHint").textContent = vals.length ? `Start ${vals[0]} ‚Üí Now ${vals[vals.length-1]}` : "‚Äî";

      // table rows
      $("mmBody").innerHTML = hist.map((h, idx) => {
        const adj = (h.adj == null) ? "‚Äî" : (h.adj >= 0 ? `+${h.adj}` : `${h.adj}`);
        const pts = (h.pts == null) ? "‚Äî" : h.pts;
        const band = (h.band == null) ? "‚Äî" : h.band;
        const label = (idx === 0) ? "Start" : (h.roundId || h.roundLabel || "");
        return `
          <tr class="text-sm">
            <td class="p-3">${escapeHtml(label)}</td>
            <td class="p-3">${escapeHtml(h.course || "‚Äî")}</td>
            <td class="p-3 text-right tabular-nums">${pts}</td>
            <td class="p-3 text-right tabular-nums">${band}</td>
            <td class="p-3 text-right tabular-nums">${adj}</td>
            <td class="p-3 text-right font-semibold tabular-nums">${h.newHcap}</td>
          </tr>
        `;
      }).join("");

      $("memberModal").classList.remove("hidden");
      $("memberModal").classList.add("flex");
      document.body.style.overflow = "hidden";
    }

    function closeMemberModal() {
      $("memberModal").classList.add("hidden");
      $("memberModal").classList.remove("flex");
      document.body.style.overflow = "";
    }

    // =========================
    // Render
    // =========================
    function render() {
      const cfg = getCfg();

      $("seasonLabel").textContent = cfg.seasonLabel || "Season";
      $("statMembers").textContent = String((DATA.members || []).length);
      $("statRounds").textContent = String((DATA.rounds || []).length);
      $("statResults").textContent = String((DATA.results || []).length);

      // upcoming from config
      $("upTitle").textContent = cfg["upcoming.title"] || "‚Äî";
      $("upWhen").textContent = `${cfg["upcoming.date"] || "‚Äî"} ‚Ä¢ ${cfg["upcoming.time"] || "‚Äî"}`;
      $("upWhere").innerHTML = `<span class="font-semibold">Location:</span> ${escapeHtml(cfg["upcoming.course"] || "‚Äî")}, ${escapeHtml(cfg["upcoming.location"] || "‚Äî")}`;
      $("upFormat").innerHTML = `<span class="font-semibold">Format:</span> ${escapeHtml(cfg["upcoming.format"] || "Stableford")}`;
      $("upNotes").textContent = cfg["upcoming.notes"] || "";

      const q = $("searchBox")?.value || "";
      const league = computeLeaderboard(q);

      // leaderboard home
      $("lbCardsHome").innerHTML = league.map(lbCard).join("");
      $("lbTableHome").innerHTML = league.map(lbRow).join("");

      // leaderboard page
      $("lbCards").innerHTML = league.map(lbCard).join("");
      $("lbTable").innerHTML = league.map(lbRow).join("");

      // rounds page
      const rankMap = buildRoundRanks();
      $("roundsGrid").innerHTML = (DATA.rounds || [])
        .slice()
        .sort((a,b)=> new Date(b.date) - new Date(a.date))
        .map(r => roundCard(r, rankMap))
        .join("") || `<div class="text-slate-500">No rounds yet.</div>`;

      // members grid (clickable)
      $("membersGrid").innerHTML = (DATA.members || []).map(m => `
        <button type="button" data-member="${escapeHtml(m.name)}" class="text-left bg-white p-4 rounded-2xl shadow-sm border border-black/10 hover:bg-black/5">
          <div class="font-semibold truncate text-[var(--augusta-900)]">${escapeHtml(m.name)}</div>
          <div class="text-sm text-slate-600">${escapeHtml(m.role || "Member")}</div>
          <div class="mt-2 text-xs text-[var(--augusta-700)]">Tap to view history</div>
        </button>
      `).join("");

      document.querySelectorAll("[data-member]").forEach(btn => {
        btn.addEventListener("click", () => openMemberModal(btn.getAttribute("data-member")));
      });

      showPage();
    }

    // =========================
    // Sync from Sheets
    // =========================
    async function syncAll() {
      setStatus("Fetching‚Ä¶", "Loading Google Sheets data");

      const [Members, Rounds, Results, Config, HandicapRules] = await Promise.all([
        fetchTab("Members"),
        fetchTab("Rounds"),
        fetchTab("Results"),
        fetchTab("Config"),
        fetchTab("HandicapRules"),
      ]);

      // Members
      DATA.members = (Members || []).map(r => ({
        name: normName(r.name ?? r.Name ?? r.player ?? r.Player ?? ""),
        role: normName(r.role ?? r.Role ?? "Member") || "Member",
        startHandicapIndex: toNumOrNull(r.startHandicapIndex ?? r.startHandicap ?? r.Handicap ?? r.handicap ?? 0) ?? 0
      })).filter(x => x.name);

      // Rounds
      DATA.rounds = (Rounds || []).map(r => ({
        id: normRoundId(r.id ?? r.ID ?? r.roundId ?? r.RoundId ?? ""),
        date: String(r.date ?? r.Date ?? "").trim(),
        course: normName(r.course ?? r.Course ?? ""),
        format: normName(r.format ?? r.Format ?? "Stableford") || "Stableford"
      })).filter(x => x.id);

      // Results (IGNORE position completely ‚Äî we always rank from score)
      DATA.results = (Results || []).map(r => ({
        roundId: normRoundId(r.roundId ?? r.RoundId ?? r.round ?? r.Round ?? ""),
        name: normName(r.name ?? r.Name ?? r.player ?? r.Player ?? ""),
        stablefordPoints: toNumOrNull(r.stablefordPoints ?? r.StablefordPoints ?? r.points ?? r.Points ?? r.score ?? r.Score)
      })).filter(x => x.roundId && x.name);

      // Config
      DATA.config = (Config || []).map(r => ({
        key: String(r.key ?? r.Key ?? "").trim(),
        value: String(r.value ?? r.Value ?? "")
      })).filter(x => x.key);

      // Handicap rules -> lookup
      adjLookup = new Map();
      for (const r of (HandicapRules || [])) {
        const band = toNumOrNull(r.band ?? r.Band);
        const score = toNumOrNull(r.score ?? r.Score);
        const adj  = toNumOrNull(r.adjustment ?? r.Adjustment ?? r.adj ?? r.Adj);
        if (band == null || score == null || adj == null) continue;
        adjLookup.set(`${Math.trunc(band)}:${Math.trunc(score)}`, Number(adj));
      }

      // Basic validation hint
      const missingRules = adjLookup.size === 0;
      const detail = `Members ${DATA.members.length} ¬∑ Rounds ${DATA.rounds.length} ¬∑ Results ${DATA.results.length}` + (missingRules ? " ¬∑ ‚ö† No handicap rules found" : "");
      setStatus("Loaded ‚úÖ", detail);

      render();
    }

    // =========================
    // Events
    // =========================
    window.addEventListener("hashchange", showPage);
    document.querySelectorAll(".navLink").forEach(a => a.addEventListener("click", () => setTimeout(showPage, 0)));

    $("btnRefresh").addEventListener("click", () => syncAll().catch(err => setStatus("Error ‚ùå", String(err))));
    $("btnRefreshTop").addEventListener("click", () => syncAll().catch(err => setStatus("Error ‚ùå", String(err))));
    $("searchBox").addEventListener("input", render);
    $("btnReset").addEventListener("click", () => { $("searchBox").value=""; render(); });

    $("mmClose").addEventListener("click", closeMemberModal);
    $("memberModal").addEventListener("click", (e) => { if (e.target === $("memberModal")) closeMemberModal(); });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !$("memberModal").classList.contains("hidden")) closeMemberModal();
    });

    // Boot
    setStatus("Ready", "Loading‚Ä¶");
    syncAll().catch(err => setStatus("Error ‚ùå", String(err)));
  </script>
</body>
</html>
