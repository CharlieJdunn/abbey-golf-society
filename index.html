<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abbey Golf Society</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-b from-emerald-50 via-white to-white min-h-screen font-sans">
  <!-- Header -->
  <div class="sticky top-0 z-20 border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="#home" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl border bg-gradient-to-br from-white to-emerald-100 flex items-center justify-center shadow-sm">
          <span class="text-xl">üèÜ</span>
        </div>
        <div class="leading-tight">
          <div class="font-semibold tracking-tight">Abbey Golf Society</div>
          <div class="text-xs text-gray-500">Google Sheets backend ¬∑ read-only site</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <nav class="hidden sm:flex items-center gap-2">
          <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm" href="#home">Home</a>
          <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm" href="#leaderboard">Leaderboard</a>
          <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm" href="#rounds">Rounds</a>
          <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm" href="#members">Members</a>
          <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm" href="#honours">Honours</a>
        </nav>

        <!-- Admin is a plain link (works even if JS dies) -->
        <a id="adminLink"
           class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-medium shadow hover:bg-emerald-700"
           target="_blank" rel="noopener">
          Admin
        </a>
      </div>
    </div>

    <div class="sm:hidden border-t bg-white/70">
      <div class="max-w-6xl mx-auto px-4 py-2 flex gap-2 overflow-x-auto">
        <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm whitespace-nowrap" href="#home">Home</a>
        <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm whitespace-nowrap" href="#leaderboard">Leaderboard</a>
        <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm whitespace-nowrap" href="#rounds">Rounds</a>
        <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm whitespace-nowrap" href="#members">Members</a>
        <a class="navLink px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm whitespace-nowrap" href="#honours">Honours</a>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-10">
    <!-- Always-visible debug status (so we can see failures without console) -->
    <section class="rounded-3xl border bg-white shadow p-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <div class="text-sm text-gray-500">Status</div>
          <div id="statusLine" class="font-semibold">Booting‚Ä¶</div>
          <div id="statusDetail" class="text-xs text-gray-500 mt-1">‚Äî</div>
        </div>
        <div class="flex gap-2">
          <!-- Refresh exists in plain HTML -->
          <button id="btnRefresh" class="px-4 py-2 rounded-2xl border bg-white hover:bg-gray-50">Refresh</button>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section id="pageHome" class="page space-y-6">
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-3xl shadow p-6 lg:col-span-2 border">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <div class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-1 text-xs font-medium">
                <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                <span id="seasonLabel">Season</span>
              </div>
              <h1 class="mt-3 text-2xl sm:text-3xl font-semibold tracking-tight">Society dashboard</h1>
              <p class="mt-2 text-sm text-gray-600">Live data pulled from Google Sheets.</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <div class="rounded-2xl border bg-white/60 px-3 py-2 shadow-sm text-sm"><span class="text-gray-500">Members:</span> <span id="statMembers" class="font-semibold">‚Äî</span></div>
              <div class="rounded-2xl border bg-white/60 px-3 py-2 shadow-sm text-sm"><span class="text-gray-500">Rounds:</span> <span id="statRounds" class="font-semibold">‚Äî</span></div>
              <div class="rounded-2xl border bg-white/60 px-3 py-2 shadow-sm text-sm"><span class="text-gray-500">Next:</span> <span id="statNext" class="font-semibold">‚Äî</span></div>
            </div>
          </div>

          <div class="mt-5 flex items-center gap-2">
            <input id="searchBox" class="w-full md:w-80 rounded-2xl border px-4 py-2" placeholder="Search players‚Ä¶" />
            <button id="btnReset" class="px-4 py-2 rounded-2xl border bg-white hover:bg-gray-50">Reset</button>
          </div>

          <div class="mt-5 bg-white rounded-2xl shadow border overflow-hidden">
            <table class="w-full text-left">
              <thead class="bg-emerald-100">
                <tr class="text-sm">
                  <th class="p-3 w-10">#</th>
                  <th class="p-3">Player</th>
                  <th class="p-3 text-right">Points</th>
                  <th class="p-3 text-right">Played</th>
                  <th class="p-3 text-right">Wins</th>
                  <th class="p-3 text-right">Hcap</th>
                </tr>
              </thead>
              <tbody id="leaderboardBodyHome"></tbody>
            </table>
          </div>
        </div>

        <div class="bg-white rounded-3xl shadow p-6 border">
          <h2 class="text-lg font-semibold">Upcoming Round</h2>
          <div class="mt-3 space-y-1">
            <div id="upTitle" class="text-xl font-bold">‚Äî</div>
            <div id="upWhen" class="text-gray-600">‚Äî</div>
            <div id="upWhere" class="mt-2">‚Äî</div>
            <div id="upFormat" class="text-gray-700">‚Äî</div>
            <div id="upNotes" class="mt-3 text-sm text-gray-600">‚Äî</div>
          </div>
        </div>
      </section>
    </section>

    <!-- LEADERBOARD -->
    <section id="pageLeaderboard" class="page hidden space-y-4">
      <h2 class="text-2xl font-semibold">Leaderboard</h2>
      <div class="bg-white rounded-2xl shadow border overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-emerald-100">
            <tr class="text-sm">
              <th class="p-3 w-10">#</th>
              <th class="p-3">Player</th>
              <th class="p-3 text-right">Points</th>
              <th class="p-3 text-right">Played</th>
              <th class="p-3 text-right">Wins</th>
              <th class="p-3 text-right">Hcap</th>
              <th class="p-3 text-right">Top-3</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ROUNDS -->
    <section id="pageRounds" class="page hidden space-y-4">
      <h2 class="text-2xl font-semibold">Rounds</h2>
      <div id="roundsGrid" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- MEMBERS -->
    <section id="pageMembers" class="page hidden space-y-4">
      <h2 class="text-2xl font-semibold">Members</h2>
      <div id="membersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- HONOURS -->
    <section id="pageHonours" class="page hidden space-y-4">
      <h2 class="text-2xl font-semibold">Honours</h2>
      <div class="bg-white rounded-2xl shadow border p-6 grid md:grid-cols-3 gap-6">
        <div><h3 class="font-bold mb-2">League Winners</h3><ul id="honoursLeague" class="list-disc list-inside text-gray-700"></ul></div>
        <div><h3 class="font-bold mb-2">Majors</h3><ul id="honoursMajors" class="list-disc list-inside text-gray-700"></ul></div>
        <div><h3 class="font-bold mb-2">Fun Awards</h3><ul id="honoursFun" class="list-disc list-inside text-gray-700"></ul></div>
      </div>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const SHEET_ID = "1jFLU54LLj3RMcdWIeKOMz8UO8HuWbAXm8ZzhRGeFjUk";
    const SHEET_URL = (tab) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;

    // Admin link is plain HTML
    document.getElementById("adminLink").href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?usp=sharing`;

    const $ = (id) => document.getElementById(id);

    function setStatus(line, detail="") {
      $("statusLine").textContent = line;
      $("statusDetail").textContent = detail || "‚Äî";
    }

    // ===== CSV parser (simple + robust enough for our sheets) =====
    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0; i<text.length; i++) {
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && (ch === ",")) { row.push(cur); cur = ""; continue; }
        if (!inQuotes && (ch === "\n")) { row.push(cur); rows.push(row); row = []; cur = ""; continue; }

        if (ch !== "\r") cur += ch;
      }
      row.push(cur);
      rows.push(row);

      // trim empty trailing rows
      return rows.filter(r => r.some(c => String(c).trim() !== ""));
    }

    function toObjects(rows) {
      if (!rows.length) return [];
      const headers = rows[0].map(h => String(h).trim());
      return rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h, i) => o[h] = r[i] ?? "");
        return o;
      }).filter(o => Object.values(o).some(v => String(v).trim() !== ""));
    }

    async function fetchTab(tab) {
      const res = await fetch(SHEET_URL(tab), { cache: "no-store" });
      if (!res.ok) throw new Error(`${tab} fetch failed (${res.status})`);
      const text = await res.text();
      return toObjects(parseCSV(text));
    }

    // ===== handicap rules =====
    let adjLookup = new Map(); // key: band:score -> adjustment

    function round1(n){ return Math.round((Number(n)+Number.EPSILON)*10)/10; }
    function bandFromHandicap(h) {
      const x = Math.round(Number(h) || 0);
      if (x >= 29) return 4;
      if (x >= 20) return 3;
      if (x >= 11) return 2;
      return 1;
    }
    function getAdj(h, pts) {
      const b = bandFromHandicap(h);
      const s = Math.trunc(Number(pts));
      const k = `${b}:${s}`;
      const a = adjLookup.get(k);
      return { band: b, adj: (typeof a === "number" ? a : 0) };
    }

    // ===== routing =====
    const ROUTES = { home:"pageHome", leaderboard:"pageLeaderboard", rounds:"pageRounds", members:"pageMembers", honours:"pageHonours" };
    function showPage() {
      const hash = (location.hash || "#home").slice(1).toLowerCase();
      const pageId = ROUTES[hash] || ROUTES.home;
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      $(pageId).classList.remove("hidden");
    }

    // ===== render =====
    let DATA = { members:[], rounds:[], results:[], honours:[], config:[], rules:[] };

    function computeCurrentHandicaps() {
      const startMap = new Map(DATA.members.map(m => [m.name, Number(m.startHandicapIndex || 0)]));
      const curMap = new Map(startMap);

      const roundsById = new Map(DATA.rounds.map(r => [r.id, r]));
      const resultsByRound = new Map();
      for (const rr of DATA.results) {
        const rid = rr.roundId;
        if (!resultsByRound.has(rid)) resultsByRound.set(rid, []);
        resultsByRound.get(rid).push(rr);
      }

      const sortedRounds = [...DATA.rounds].sort((a,b) => new Date(a.date) - new Date(b.date));
      for (const r of sortedRounds) {
        const res = resultsByRound.get(r.id) || [];
        for (const x of res) {
          if (!curMap.has(x.name)) continue;
          if (x.stablefordPoints === "" || x.stablefordPoints == null) continue;
          const cur = curMap.get(x.name);
          const { adj } = getAdj(cur, x.stablefordPoints);
          curMap.set(x.name, Math.max(0, round1(cur + adj)));
        }
      }
      return curMap;
    }

    function computeLeague() {
      const currentHcap = computeCurrentHandicaps();
      const rows = DATA.members.map(m => ({
        name: m.name,
        role: m.role || "Member",
        points: 0,
        played: 0,
        wins: 0,
        top3: 0,
        handicapIndex: currentHcap.get(m.name) ?? Number(m.startHandicapIndex || 0)
      }));

      const rowMap = new Map(rows.map(r => [r.name, r]));

      // basic position points (can be moved to Config later)
      const positionPoints = [20,16,14,12,10,8,6,4,2,1];
      const winBonus = 2, participation = 2, top3Bonus = 1;

      for (const rr of DATA.results) {
        const row = rowMap.get(rr.name);
        if (!row) continue;
        row.played += 1;
        row.points += participation;

        const pos = Number(rr.position);
        if (Number.isFinite(pos) && pos >= 1) {
          row.points += Number(positionPoints[pos-1] || 0);
          if (pos === 1) { row.wins += 1; row.points += winBonus; }
          if (pos <= 3) { row.top3 += 1; row.points += top3Bonus; }
        }
      }

      // search
      const q = String($("searchBox").value || "").trim().toLowerCase();
      const filtered = q ? rows.filter(r => r.name.toLowerCase().includes(q)) : rows;

      filtered.sort((a,b) => (b.points-a.points) || (b.wins-a.wins) || a.name.localeCompare(b.name));
      return filtered.map((r,i) => ({ rank:i+1, ...r }));
    }

    function render() {
      const cfg = Object.fromEntries(DATA.config.map(x => [x.key, x.value]));
      $("seasonLabel").textContent = cfg.seasonLabel || "Season";
      $("statMembers").textContent = DATA.members.length;
      $("statRounds").textContent = DATA.rounds.length;
      $("statNext").textContent = cfg["upcoming.date"] || "‚Äî";

      $("upTitle").textContent = cfg["upcoming.title"] || "‚Äî";
      $("upWhen").textContent = `${cfg["upcoming.date"] || "‚Äî"} ‚Ä¢ ${cfg["upcoming.time"] || "‚Äî"}`;
      $("upWhere").innerHTML = `<span class="font-semibold">Location:</span> ${cfg["upcoming.course"] || "‚Äî"}, ${cfg["upcoming.location"] || "‚Äî"}`;
      $("upFormat").innerHTML = `<span class="font-semibold">Format:</span> ${cfg["upcoming.format"] || "Stableford"}`;
      $("upNotes").textContent = cfg["upcoming.notes"] || "";

      const league = computeLeague();
      $("leaderboardBodyHome").innerHTML = league.slice(0,10).map(r => `
        <tr class="border-t ${r.rank===1?"bg-amber-50/60":""}">
          <td class="p-3 font-semibold">${r.rank}</td>
          <td class="p-3"><div class="font-medium">${r.name}</div><div class="text-xs text-gray-500">${r.role}</div></td>
          <td class="p-3 text-right font-semibold tabular-nums">${r.points}</td>
          <td class="p-3 text-right tabular-nums">${r.played}</td>
          <td class="p-3 text-right tabular-nums">${r.wins}</td>
          <td class="p-3 text-right tabular-nums">${r.handicapIndex}</td>
        </tr>`).join("");

      $("leaderboardBody").innerHTML = league.map(r => `
        <tr class="border-t ${r.rank===1?"bg-amber-50/60":""}">
          <td class="p-3 font-semibold">${r.rank}</td>
          <td class="p-3"><div class="font-medium">${r.name}</div><div class="text-xs text-gray-500">${r.role}</div></td>
          <td class="p-3 text-right font-semibold tabular-nums">${r.points}</td>
          <td class="p-3 text-right tabular-nums">${r.played}</td>
          <td class="p-3 text-right tabular-nums">${r.wins}</td>
          <td class="p-3 text-right tabular-nums">${r.handicapIndex}</td>
          <td class="p-3 text-right tabular-nums">${r.top3}</td>
        </tr>`).join("");

      $("roundsGrid").innerHTML = DATA.rounds
        .slice()
        .sort((a,b)=>new Date(b.date)-new Date(a.date))
        .map(r => `
          <div class="bg-white rounded-2xl shadow border p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-bold">${r.course || "‚Äî"}</div>
                <div class="text-gray-600 text-sm">${r.date || ""} ‚Ä¢ ${r.format || ""}</div>
              </div>
              <span class="text-xs px-3 py-1 rounded-2xl bg-gray-100 border">${r.id}</span>
            </div>
          </div>
        `).join("") || "<div class='text-gray-500'>No rounds yet.</div>";

      $("membersGrid").innerHTML = DATA.members.map(m => `
        <div class="bg-white p-4 rounded-2xl shadow border">
          <div class="font-semibold truncate">${m.name}</div>
          <div class="text-sm text-gray-600">${m.role || "Member"} ‚Ä¢ Start ${m.startHandicapIndex}</div>
        </div>
      `).join("");

      // honours (optional)
      const leagueWins = DATA.honours.filter(h => String(h.type).toLowerCase() === "league");
      const majors = DATA.honours.filter(h => String(h.type).toLowerCase() === "major");
      const fun = DATA.honours.filter(h => String(h.type).toLowerCase() === "fun");

      $("honoursLeague").innerHTML = leagueWins.map(x => `<li>${x.year} ‚Äî ${x.winner}</li>`).join("");
      $("honoursMajors").innerHTML = majors.map(x => `<li>${x.title} ${x.year} ‚Äî ${x.winner}</li>`).join("");
      $("honoursFun").innerHTML = fun.map(x => `<li>${x.title || x.award} ${x.year} ‚Äî ${x.winner}</li>`).join("");

      showPage();
    }

    async function syncAll() {
      setStatus("Fetching Google Sheets‚Ä¶", "If this hangs, your tabs/headers may not match.");

      // Fetch tabs
      const [Members, Rounds, Results, Honours, Config, HandicapRules] = await Promise.all([
        fetchTab("Members"),
        fetchTab("Rounds"),
        fetchTab("Results"),
        fetchTab("Honours"),
        fetchTab("Config"),
        fetchTab("HandicapRules"),
      ]);

      // Normalise expected columns
      DATA.members = Members.map(r => ({
        name: r.name || r.Name || "",
        role: r.role || r.Role || "Member",
        startHandicapIndex: r.startHandicapIndex || r.startHandicap || r.Handicap || 0
      })).filter(x => String(x.name).trim() !== "");

      DATA.rounds = Rounds.map(r => ({
        id: r.id || r.ID || r.roundId || r.RoundId || "",
        date: r.date || r.Date || "",
        course: r.course || r.Course || "",
        format: r.format || r.Format || "Stableford"
      })).filter(x => String(x.id).trim() !== "");

      DATA.results = Results.map(r => ({
        roundId: r.roundId || r.RoundId || "",
        name: r.name || r.Name || "",
        position: r.position || r.Position || "",
        stablefordPoints: r.stablefordPoints || r.StablefordPoints || r.points || r.Points || ""
      })).filter(x => String(x.roundId).trim() && String(x.name).trim());

      DATA.honours = Honours;
      DATA.config = Config.map(r => ({ key: r.key || r.Key || "", value: r.value || r.Value || "" })).filter(x => x.key);
      DATA.rules = HandicapRules;

      // Build handicap lookup
      adjLookup = new Map();
      for (const r of HandicapRules) {
        const band = Number(r.band || r.Band);
        const score = Number(r.score || r.Score);
        const adj = Number(r.adjustment || r.Adjustment);
        if (Number.isFinite(band) && Number.isFinite(score) && Number.isFinite(adj)) {
          adjLookup.set(`${band}:${Math.trunc(score)}`, adj);
        }
      }

      setStatus("Loaded ‚úÖ", `Members: ${DATA.members.length} ¬∑ Rounds: ${DATA.rounds.length} ¬∑ Results: ${DATA.results.length} ¬∑ Rules: ${adjLookup.size}`);
      render();
    }

    // Wire events (these exist even before data loads)
    window.addEventListener("hashchange", showPage);
    document.querySelectorAll(".navLink").forEach(a => a.addEventListener("click", () => setTimeout(showPage, 0)));

    $("btnRefresh").addEventListener("click", () => syncAll().catch(err => setStatus("Error ‚ùå", String(err))));
    $("searchBox").addEventListener("input", render);
    $("btnReset").addEventListener("click", () => { $("searchBox").value=""; render(); });

    // Boot
    setStatus("Ready", "Press Refresh to load data from the Google Sheet.");
    // Auto load once
    syncAll().catch(err => setStatus("Error ‚ùå", String(err)));
  </script>
</body>
</html>
