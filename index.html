<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abbey Golf Society</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --augusta-950:#07140e;
      --augusta-900:#0b1f16;
      --augusta-800:#0f2d22;
      --augusta-700:#144232;
      --augusta-600:#1b5a43;
      --paper:#f7f6f1;
    }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .serif { font-family: "Playfair Display", Georgia, serif; }
    :focus-visible{ outline: 3px solid rgba(27,90,67,.35); outline-offset: 2px; border-radius: 16px; }
  </style>
</head>

<body class="bg-[var(--paper)] text-slate-900 min-h-screen">
  <!-- Header -->
  <div class="sticky top-0 z-20 border-b border-black/5 bg-[var(--paper)]/85 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="#home" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl border border-black/10 bg-white shadow-sm flex items-center justify-center overflow-hidden">
          <img src="./assets/logo.png" alt="Abbey Golf Society" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <div class="font-semibold tracking-tight">Abbey Golf Society</div>
          <div class="text-xs text-slate-600">Official Portal</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <nav class="hidden sm:flex items-center gap-2">
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#home">Home</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#leaderboard">Leaderboard</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#rounds">Rounds</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#members">Members</a>
          <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm" href="#honours">Honours</a>
        </nav>

        <a id="adminLink"
           class="px-4 py-2 rounded-2xl bg-[var(--augusta-800)] text-white font-medium shadow-sm hover:bg-[var(--augusta-700)] border border-black/10"
           target="_blank" rel="noopener">
          Admin
        </a>
      </div>
    </div>

    <div class="sm:hidden border-t border-black/5 bg-[var(--paper)]/70">
      <div class="max-w-6xl mx-auto px-4 py-2 flex gap-2 overflow-x-auto">
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#home">Home</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#leaderboard">Leaderboard</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#rounds">Rounds</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#members">Members</a>
        <a class="navLink px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm whitespace-nowrap" href="#honours">Honours</a>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- Slim Hero -->
    <section class="rounded-3xl border border-black/10 overflow-hidden shadow-sm bg-white">
      <div class="bg-gradient-to-br from-[var(--augusta-950)] via-[var(--augusta-900)] to-[var(--augusta-800)] text-white">
        <div class="px-5 py-6 sm:py-7">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-2xl bg-white/10 border border-white/15 shadow flex items-center justify-center overflow-hidden">
                <img src="./assets/logo.png" alt="Abbey Golf Society logo" class="w-full h-full object-contain p-2">
              </div>
              <div>
                <h1 class="serif text-2xl sm:text-3xl font-bold tracking-tight">Abbey Golf Society</h1>
                <p class="text-white/80 text-sm mt-1">Fixtures · Standings · Results</p>
              </div>
            </div>

            <a href="#leaderboard" class="hidden sm:inline-flex px-4 py-2 rounded-2xl bg-white text-[var(--augusta-900)] font-medium hover:bg-white/90">
              View standings
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section id="pageHome" class="page space-y-6">
      <!-- Upcoming first -->
      <section class="bg-white rounded-3xl shadow-sm p-6 border border-black/10">
        <div class="flex items-center justify-between">
          <h2 class="serif text-xl font-bold">Upcoming Round</h2>
          <span class="text-xs px-3 py-1 rounded-2xl bg-[var(--paper)] border border-black/10 text-slate-600">Next</span>
        </div>

        <div class="mt-4 grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <div id="upTitle" class="text-2xl font-bold text-[var(--augusta-900)]">—</div>
            <div id="upWhen" class="text-slate-600 mt-1">—</div>
            <div id="upWhere" class="mt-3 text-slate-800">—</div>
            <div id="upFormat" class="text-slate-800 mt-1">—</div>
            <div id="upNotes" class="mt-3 text-sm text-slate-600">—</div>
          </div>

          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-600">Season</div>
            <div id="seasonLabel" class="font-semibold mt-1">Season</div>

            <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
              <div class="rounded-2xl border border-black/10 bg-white px-3 py-2 text-center">
                <div class="text-xs text-slate-500">Members</div>
                <div id="statMembers" class="font-semibold">—</div>
              </div>
              <div class="rounded-2xl border border-black/10 bg-white px-3 py-2 text-center">
                <div class="text-xs text-slate-500">Rounds</div>
                <div id="statRounds" class="font-semibold">—</div>
              </div>
              <div class="rounded-2xl border border-black/10 bg-white px-3 py-2 text-center">
                <div class="text-xs text-slate-500">Next</div>
                <div id="statNext" class="font-semibold">—</div>
              </div>
            </div>

            <div class="mt-4 flex gap-2">
              <a href="#rounds" class="flex-1 text-center px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5 text-sm">Rounds</a>
              <a href="#leaderboard" class="flex-1 text-center px-3 py-2 rounded-2xl bg-[var(--augusta-800)] text-white hover:bg-[var(--augusta-700)] text-sm">Standings</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Full standings -->
      <section class="bg-white rounded-3xl shadow-sm p-6 border border-black/10">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
          <div>
            <h2 class="serif text-xl font-bold">Standings</h2>
            <p class="text-sm text-slate-600 mt-1">All members · live points & handicap.</p>
          </div>

          <div class="flex items-center gap-2">
            <input id="searchBox" class="w-full sm:w-72 rounded-2xl border border-black/10 px-4 py-2 bg-white" placeholder="Search players…" />
            <button id="btnReset" class="px-4 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5">Reset</button>
          </div>
        </div>

        <div id="leaderboardCardsHome" class="mt-5 grid gap-3 sm:hidden"></div>

        <div class="mt-5 bg-white rounded-2xl shadow-sm border border-black/10 overflow-hidden hidden sm:block">
          <table class="w-full text-left">
            <thead class="bg-[var(--augusta-900)] text-white">
              <tr class="text-sm">
                <th class="p-3 w-10">#</th>
                <th class="p-3">Player</th>
                <th class="p-3 text-right">Points</th>
                <th class="p-3 text-right">Played</th>
                <th class="p-3 text-right">Wins</th>
                <th class="p-3 text-right">Hcap</th>
              </tr>
            </thead>
            <tbody id="leaderboardBodyHome" class="divide-y divide-black/5"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- LEADERBOARD PAGE -->
    <section id="pageLeaderboard" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Leaderboard</h2>

      <div id="leaderboardCards" class="grid gap-3 sm:hidden"></div>

      <div class="bg-white rounded-2xl shadow-sm border border-black/10 overflow-hidden hidden sm:block">
        <table class="w-full text-left">
          <thead class="bg-[var(--augusta-900)] text-white">
            <tr class="text-sm">
              <th class="p-3 w-10">#</th>
              <th class="p-3">Player</th>
              <th class="p-3 text-right">Points</th>
              <th class="p-3 text-right">Played</th>
              <th class="p-3 text-right">Wins</th>
              <th class="p-3 text-right">Hcap</th>
              <th class="p-3 text-right">Top-3</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody" class="divide-y divide-black/5"></tbody>
        </table>
      </div>
    </section>

    <!-- ROUNDS (UPGRADED) -->
    <section id="pageRounds" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Rounds</h2>
      <div id="roundsGrid" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- MEMBERS (CLICKABLE -> MODAL) -->
    <section id="pageMembers" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Members</h2>
      <p class="text-sm text-slate-600">Tap a member to view their season stats and handicap trend.</p>
      <div id="membersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <!-- HONOURS -->
    <section id="pageHonours" class="page hidden space-y-4">
      <h2 class="serif text-2xl font-bold">Honours</h2>
      <div class="bg-white rounded-2xl shadow-sm border border-black/10 p-6 grid md:grid-cols-3 gap-6">
        <div>
          <h3 class="font-bold mb-2 text-[var(--augusta-900)]">League Winners</h3>
          <ul id="honoursLeague" class="list-disc list-inside text-slate-700"></ul>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-[var(--augusta-900)]">Majors</h3>
          <ul id="honoursMajors" class="list-disc list-inside text-slate-700"></ul>
        </div>
        <div>
          <h3 class="font-bold mb-2 text-[var(--augusta-900)]">Fun Awards</h3>
          <ul id="honoursFun" class="list-disc list-inside text-slate-700"></ul>
        </div>
      </div>
    </section>

    <!-- Footer (status tucked away) -->
    <footer class="py-10 text-center space-y-3">
      <div class="text-xs text-slate-500">© 2026 Abbey Golf Society</div>

      <div class="inline-flex flex-col sm:flex-row sm:items-center gap-2 justify-center text-xs">
        <div class="px-3 py-2 rounded-2xl border border-black/10 bg-white">
          <span id="statusLine" class="font-semibold">Ready</span>
          <span class="text-slate-500">·</span>
          <span id="statusDetail" class="text-slate-500">Loading…</span>
        </div>
        <button id="btnRefresh" class="px-3 py-2 rounded-2xl border border-black/10 bg-white hover:bg-black/5">
          Refresh
        </button>
      </div>
    </footer>
  </main>

  <!-- MEMBER MODAL -->
  <div id="memberModal" class="fixed inset-0 hidden items-end sm:items-center justify-center bg-black/40 p-3 z-50">
    <div class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl border border-black/10 overflow-hidden">
      <div class="px-5 py-4 border-b border-black/10 flex items-center justify-between gap-3">
        <div>
          <div class="text-xs text-slate-500">Member</div>
          <div id="mmName" class="serif text-xl font-bold text-[var(--augusta-900)]">—</div>
          <div id="mmRole" class="text-sm text-slate-600">—</div>
        </div>
        <button id="mmClose" class="px-3 py-2 rounded-2xl border border-black/10 hover:bg-black/5">Close</button>
      </div>

      <div class="p-5 space-y-5">
        <div class="grid sm:grid-cols-3 gap-3">
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Current Handicap</div>
            <div id="mmHcap" class="text-2xl font-bold tabular-nums mt-1">—</div>
          </div>
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Season Stats</div>
            <div id="mmStats" class="text-sm text-slate-700 mt-2">—</div>
          </div>
          <div class="rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Handicap Trend</div>
            <div class="mt-2">
              <svg id="mmSpark" viewBox="0 0 120 36" class="w-full h-9">
                <polyline id="mmSparkLine" fill="none" stroke="rgba(27,90,67,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points=""></polyline>
              </svg>
              <div id="mmSparkHint" class="text-xs text-slate-500 mt-1">—</div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border border-black/10 overflow-hidden">
          <div class="px-4 py-3 bg-[var(--augusta-900)] text-white text-sm font-semibold">Handicap history</div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-white">
                <tr class="text-xs text-slate-500">
                  <th class="p-3">Round</th>
                  <th class="p-3">Course</th>
                  <th class="p-3 text-right">Pts</th>
                  <th class="p-3 text-right">Adj</th>
                  <th class="p-3 text-right">Hcap</th>
                </tr>
              </thead>
              <tbody id="mmBody" class="divide-y divide-black/5"></tbody>
            </table>
          </div>
        </div>

        <div class="text-xs text-slate-500">
          Adjustments are applied only when Stableford points are present for that round.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const SHEET_ID = "1jFLU54LLj3RMcdWIeKOMz8UO8HuWbAXm8ZzhRGeFjUk";
    const SHEET_URL = (tab) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;

    document.getElementById("adminLink").href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?usp=sharing`;

    const $ = (id) => document.getElementById(id);

    function setStatus(line, detail="") {
      $("statusLine").textContent = line;
      $("statusDetail").textContent = detail || "—";
    }

    // ===== CSV parser =====
    function parseCSV(text) {
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0; i<text.length; i++) {
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && (ch === ",")) { row.push(cur); cur = ""; continue; }
        if (!inQuotes && (ch === "\n")) { row.push(cur); rows.push(row); row = []; cur = ""; continue; }

        if (ch !== "\r") cur += ch;
      }
      row.push(cur);
      rows.push(row);

      return rows.filter(r => r.some(c => String(c).trim() !== ""));
    }

    function toObjects(rows) {
      if (!rows.length) return [];
      const headers = rows[0].map(h => String(h).trim());
      return rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h, i) => o[h] = r[i] ?? "");
        return o;
      }).filter(o => Object.values(o).some(v => String(v).trim() !== ""));
    }

    async function fetchTab(tab) {
      const res = await fetch(SHEET_URL(tab), { cache: "no-store" });
      if (!res.ok) throw new Error(`${tab} fetch failed (${res.status})`);
      const text = await res.text();
      return toObjects(parseCSV(text));
    }

    // ===== handicap rules =====
    let adjLookup = new Map(); // key: band:score -> adjustment

    function round1(n){ return Math.round((Number(n)+Number.EPSILON)*10)/10; }
    function bandFromHandicap(h) {
      const x = Math.round(Number(h) || 0);
      if (x >= 29) return 4;
      if (x >= 20) return 3;
      if (x >= 11) return 2;
      return 1;
    }
    function getAdj(h, pts) {
      const b = bandFromHandicap(h);
      const s = Math.trunc(Number(pts));
      const k = `${b}:${s}`;
      const a = adjLookup.get(k);
      return { band: b, adj: (typeof a === "number" ? a : 0) };
    }

    // ===== routing =====
    const ROUTES = { home:"pageHome", leaderboard:"pageLeaderboard", rounds:"pageRounds", members:"pageMembers", honours:"pageHonours" };
    function showPage() {
      const hash = (location.hash || "#home").slice(1).toLowerCase();
      const pageId = ROUTES[hash] || ROUTES.home;
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      $(pageId).classList.remove("hidden");

      const activeKey = hash || "home";
      document.querySelectorAll(".navLink").forEach(a => {
        const isActive = a.getAttribute("href") === `#${activeKey}`;
        a.classList.toggle("ring-2", isActive);
        a.classList.toggle("ring-[rgba(27,90,67,.25)]", isActive);
      });
    }

    // ===== data =====
    let DATA = { members:[], rounds:[], results:[], honours:[], config:[], rules:[] };

    function resultsForRound(roundId){
      return DATA.results
        .filter(r => String(r.roundId).trim() === String(roundId).trim())
        .map(r => ({
          name: String(r.name || "").trim(),
          position: Number(r.position),
          stablefordPoints: (r.stablefordPoints === "" || r.stablefordPoints == null) ? null : Number(r.stablefordPoints)
        }))
        .filter(r => r.name);
    }

    function computeCurrentHandicapsWithHistory() {
      // returns { curMap, historyMap }
      const startMap = new Map(DATA.members.map(m => [m.name, Number(m.startHandicapIndex || 0)]));
      const curMap = new Map(startMap);
      const historyMap = new Map(); // name -> [{label, roundId, course, pts, adj, hcap}]

      for (const m of DATA.members) {
        historyMap.set(m.name, [{
          label: "Start",
          roundId: null,
          course: "—",
          pts: null,
          adj: null,
          hcap: round1(Number(m.startHandicapIndex || 0))
        }]);
      }

      const sortedRounds = [...DATA.rounds].sort((a,b) => new Date(a.date) - new Date(b.date));
      for (const r of sortedRounds) {
        const res = resultsForRound(r.id).sort((a,b) => (a.position||999)-(b.position||999));
        for (const x of res) {
          if (!curMap.has(x.name)) continue;

          const cur = curMap.get(x.name);
          let adj = 0;

          if (x.stablefordPoints != null && Number.isFinite(x.stablefordPoints)) {
            adj = getAdj(cur, x.stablefordPoints).adj;
            curMap.set(x.name, Math.max(0, round1(cur + adj)));
          }

          const arr = historyMap.get(x.name) || [];
          arr.push({
            label: r.date || r.id,
            roundId: r.id,
            course: r.course || "",
            pts: x.stablefordPoints,
            adj: (x.stablefordPoints == null ? null : adj),
            hcap: curMap.get(x.name)
          });
          historyMap.set(x.name, arr);
        }
      }

      return { curMap, historyMap };
    }

    function computeLeague() {
      const { curMap } = computeCurrentHandicapsWithHistory();

      const rows = DATA.members.map(m => ({
        name: m.name,
        role: m.role || "Member",
        points: 0,
        played: 0,
        wins: 0,
        top3: 0,
        handicapIndex: curMap.get(m.name) ?? Number(m.startHandicapIndex || 0)
      }));

      const rowMap = new Map(rows.map(r => [r.name, r]));

      // scoring
      const positionPoints = [20,16,14,12,10,8,6,4,2,1];
      const winBonus = 2, participation = 2, top3Bonus = 1;

      for (const rr of DATA.results) {
        const name = String(rr.name || "").trim();
        const row = rowMap.get(name);
        if (!row) continue;

        row.played += 1;
        row.points += participation;

        const pos = Number(rr.position);
        if (Number.isFinite(pos) && pos >= 1) {
          row.points += Number(positionPoints[pos-1] || 0);
          if (pos === 1) { row.wins += 1; row.points += winBonus; }
          if (pos <= 3) { row.top3 += 1; row.points += top3Bonus; }
        }
      }

      const q = String($("searchBox")?.value || "").trim().toLowerCase();
      const filtered = q ? rows.filter(r => r.name.toLowerCase().includes(q)) : rows;

      filtered.sort((a,b) => (b.points-a.points) || (b.wins-a.wins) || a.name.localeCompare(b.name));
      return filtered.map((r,i) => ({ rank:i+1, ...r }));
    }

    function leaderboardCardHtml(r, showTop3=false){
      return `
        <div class="rounded-2xl border border-black/10 bg-white p-4 shadow-sm">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-slate-500">#${r.rank}</div>
              <div class="font-semibold text-[var(--augusta-900)]">${escapeHtml(r.name)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(r.role)}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Points</div>
              <div class="text-xl font-bold tabular-nums">${r.points}</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Played</div>
              <div class="font-semibold tabular-nums">${r.played}</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Wins</div>
              <div class="font-semibold tabular-nums">${r.wins}</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-[var(--paper)] px-3 py-2 text-center">
              <div class="text-xs text-slate-500">Hcap</div>
              <div class="font-semibold tabular-nums">${r.handicapIndex}</div>
            </div>
          </div>

          ${showTop3 ? `
            <div class="mt-3 text-xs text-slate-600">
              Top-3 finishes: <span class="font-semibold tabular-nums">${r.top3}</span>
            </div>
          ` : ``}
        </div>
      `;
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
    }

    function roundCardHtml(r) {
      const res = resultsForRound(r.id).sort((a,b)=> (a.position||999)-(b.position||999));
      const top3 = res.slice(0,3);

      const winner = top3.find(x => x.position === 1) || top3[0] || null;
      const winnerLine = winner
        ? `${escapeHtml(winner.name)}${(winner.stablefordPoints!=null ? ` <span class="text-slate-500">(${winner.stablefordPoints} pts)</span>` : ``)}`
        : `<span class="text-slate-500">—</span>`;

      const top3Html = top3.length ? top3.map(x => {
        const pts = x.stablefordPoints != null ? ` · ${x.stablefordPoints} pts` : '';
        return `<li class="flex items-center justify-between gap-3">
          <span>${x.position ? `#${x.position}` : '#—'} ${escapeHtml(x.name)}</span>
          <span class="text-slate-500 text-xs tabular-nums">${pts.replace(' · ','')}</span>
        </li>`;
      }).join('') : `<li class="text-slate-500">No results yet.</li>`;

      return `
        <div class="bg-white rounded-2xl shadow-sm border border-black/10 p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-bold text-[var(--augusta-900)]">${escapeHtml(r.course || "—")}</div>
              <div class="text-slate-600 text-sm">${escapeHtml(r.date || "")} • ${escapeHtml(r.format || "")}</div>
            </div>
            <span class="text-xs px-3 py-1 rounded-2xl bg-[var(--paper)] border border-black/10 text-slate-600">${escapeHtml(r.id)}</span>
          </div>

          <div class="mt-4 rounded-2xl border border-black/10 bg-[var(--paper)] p-4">
            <div class="text-xs text-slate-500">Winner</div>
            <div class="font-semibold mt-1">${winnerLine}</div>
          </div>

          <div class="mt-4">
            <div class="text-xs text-slate-500 font-semibold uppercase tracking-wide">Top 3</div>
            <ul class="mt-2 space-y-2 text-sm text-slate-800">${top3Html}</ul>
          </div>
        </div>
      `;
    }

    // ===== member modal =====
    function openMemberModal(name) {
      const member = DATA.members.find(m => m.name === name);
      const leagueRows = computeLeague();
      const row = leagueRows.find(r => r.name === name);

      const { curMap, historyMap } = computeCurrentHandicapsWithHistory();
      const hist = historyMap.get(name) || [];
      const curHcap = curMap.get(name) ?? Number(member?.startHandicapIndex || 0);

      $("mmName").textContent = name;
      $("mmRole").textContent = member?.role ? member.role : "Member";
      $("mmHcap").textContent = String(curHcap);

      const stats = row
        ? `Points: ${row.points} · Played: ${row.played} · Wins: ${row.wins} · Top-3: ${row.top3}`
        : "—";
      $("mmStats").textContent = stats;

      // history table
      $("mmBody").innerHTML = hist.map((h, idx) => {
        const isStart = idx === 0;
        const adj = (h.adj == null) ? "—" : (h.adj >= 0 ? `+${h.adj}` : `${h.adj}`);
        const pts = (h.pts == null) ? "—" : h.pts;
        return `
          <tr class="text-sm">
            <td class="p-3">${escapeHtml(isStart ? "Start" : (h.label || h.roundId || ""))}</td>
            <td class="p-3">${escapeHtml(h.course || "—")}</td>
            <td class="p-3 text-right tabular-nums">${pts}</td>
            <td class="p-3 text-right tabular-nums">${adj}</td>
            <td class="p-3 text-right font-semibold tabular-nums">${h.hcap}</td>
          </tr>
        `;
      }).join("");

      // sparkline from handicap values
      const values = hist.map(x => Number(x.hcap)).filter(v => Number.isFinite(v));
      const hint = values.length ? `Start ${values[0]} → Now ${values[values.length-1]}` : "—";
      $("mmSparkHint").textContent = hint;

      const points = sparkPoints(values, 120, 36, 6);
      $("mmSparkLine").setAttribute("points", points);

      $("memberModal").classList.remove("hidden");
      $("memberModal").classList.add("flex");
      document.body.style.overflow = "hidden";
    }

    function closeMemberModal() {
      $("memberModal").classList.add("hidden");
      $("memberModal").classList.remove("flex");
      document.body.style.overflow = "";
    }

    function sparkPoints(values, w, h, pad) {
      if (!values || values.length < 2) return "";
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;

      const xStep = (w - pad*2) / (values.length - 1);
      return values.map((v, i) => {
        const x = pad + i * xStep;
        // invert y because SVG origin top-left
        const y = pad + (h - pad*2) * (1 - ((v - min) / range));
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
    }

    // ===== render =====
    function render() {
      const cfg = Object.fromEntries(DATA.config.map(x => [x.key, x.value]));
      $("seasonLabel").textContent = cfg.seasonLabel || "Season";
      $("statMembers").textContent = DATA.members.length;
      $("statRounds").textContent = DATA.rounds.length;
      $("statNext").textContent = cfg["upcoming.date"] || "—";

      $("upTitle").textContent = cfg["upcoming.title"] || "—";
      $("upWhen").textContent = `${cfg["upcoming.date"] || "—"} • ${cfg["upcoming.time"] || "—"}`;
      $("upWhere").innerHTML = `<span class="font-semibold">Location:</span> ${escapeHtml(cfg["upcoming.course"] || "—")}, ${escapeHtml(cfg["upcoming.location"] || "—")}`;
      $("upFormat").innerHTML = `<span class="font-semibold">Format:</span> ${escapeHtml(cfg["upcoming.format"] || "Stableford")}`;
      $("upNotes").textContent = cfg["upcoming.notes"] || "";

      const league = computeLeague();

      // tables/cards
      $("leaderboardBodyHome").innerHTML = league.map(r => `
        <tr class="border-t border-black/5 ${r.rank===1?"bg-[rgba(27,90,67,.07)]":""}">
          <td class="p-3 font-semibold">${r.rank}</td>
          <td class="p-3"><div class="font-medium">${escapeHtml(r.name)}</div><div class="text-xs text-slate-500">${escapeHtml(r.role)}</div></td>
          <td class="p-3 text-right font-semibold tabular-nums">${r.points}</td>
          <td class="p-3 text-right tabular-nums">${r.played}</td>
          <td class="p-3 text-right tabular-nums">${r.wins}</td>
          <td class="p-3 text-right tabular-nums">${r.handicapIndex}</td>
        </tr>`).join("");

      $("leaderboardCardsHome").innerHTML = league.map(r => leaderboardCardHtml(r, false)).join("");

      $("leaderboardBody").innerHTML = league.map(r => `
        <tr class="border-t border-black/5 ${r.rank===1?"bg-[rgba(27,90,67,.07)]":""}">
          <td class="p-3 font-semibold">${r.rank}</td>
          <td class="p-3"><div class="font-medium">${escapeHtml(r.name)}</div><div class="text-xs text-slate-500">${escapeHtml(r.role)}</div></td>
          <td class="p-3 text-right font-semibold tabular-nums">${r.points}</td>
          <td class="p-3 text-right tabular-nums">${r.played}</td>
          <td class="p-3 text-right tabular-nums">${r.wins}</td>
          <td class="p-3 text-right tabular-nums">${r.handicapIndex}</td>
          <td class="p-3 text-right tabular-nums">${r.top3}</td>
        </tr>`).join("");

      $("leaderboardCards").innerHTML = league.map(r => leaderboardCardHtml(r, true)).join("");

      // ROUNDS upgraded (winner + top 3)
      $("roundsGrid").innerHTML = DATA.rounds
        .slice()
        .sort((a,b)=>new Date(b.date)-new Date(a.date))
        .map(r => roundCardHtml(r))
        .join("") || "<div class='text-slate-500'>No rounds yet.</div>";

      // MEMBERS clickable
      $("membersGrid").innerHTML = DATA.members.map(m => `
        <button type="button" data-member="${escapeHtml(m.name)}" class="text-left bg-white p-4 rounded-2xl shadow-sm border border-black/10 hover:bg-black/5">
          <div class="font-semibold truncate text-[var(--augusta-900)]">${escapeHtml(m.name)}</div>
          <div class="text-sm text-slate-600">${escapeHtml(m.role || "Member")}</div>
          <div class="mt-2 text-xs text-[var(--augusta-700)]">Tap to view profile</div>
        </button>
      `).join("");

      // bind member clicks
      document.querySelectorAll("[data-member]").forEach(btn => {
        btn.addEventListener("click", () => openMemberModal(btn.getAttribute("data-member")));
      });

      // honours
      const leagueWins = DATA.honours.filter(h => String(h.type).toLowerCase() === "league");
      const majors = DATA.honours.filter(h => String(h.type).toLowerCase() === "major");
      const fun = DATA.honours.filter(h => String(h.type).toLowerCase() === "fun");

      $("honoursLeague").innerHTML = leagueWins.map(x => `<li>${escapeHtml(x.year)} — ${escapeHtml(x.winner)}</li>`).join("");
      $("honoursMajors").innerHTML = majors.map(x => `<li>${escapeHtml(x.title)} ${escapeHtml(x.year)} — ${escapeHtml(x.winner)}</li>`).join("");
      $("honoursFun").innerHTML = fun.map(x => `<li>${escapeHtml(x.title || x.award)} ${escapeHtml(x.year)} — ${escapeHtml(x.winner)}</li>`).join("");

      showPage();
    }

    async function syncAll() {
      setStatus("Fetching…", "Loading society data");

      const [Members, Rounds, Results, Honours, Config, HandicapRules] = await Promise.all([
        fetchTab("Members"),
        fetchTab("Rounds"),
        fetchTab("Results"),
        fetchTab("Honours"),
        fetchTab("Config"),
        fetchTab("HandicapRules"),
      ]);

      DATA.members = Members.map(r => ({
        name: (r.name || r.Name || "").trim(),
        role: (r.role || r.Role || "Member").trim(),
        startHandicapIndex: r.startHandicapIndex || r.startHandicap || r.Handicap || 0
      })).filter(x => String(x.name).trim() !== "");

      DATA.rounds = Rounds.map(r => ({
        id: (r.id || r.ID || r.roundId || r.RoundId || "").trim(),
        date: (r.date || r.Date || "").trim(),
        course: (r.course || r.Course || "").trim(),
        format: (r.format || r.Format || "Stableford").trim()
      })).filter(x => String(x.id).trim() !== "");

      DATA.results = Results.map(r => ({
        roundId: (r.roundId || r.RoundId || "").trim(),
        name: (r.name || r.Name || "").trim(),
        position: r.position || r.Position || "",
        stablefordPoints: r.stablefordPoints || r.StablefordPoints || r.points || r.Points || ""
      })).filter(x => String(x.roundId).trim() && String(x.name).trim());

      DATA.honours = Honours;
      DATA.config = Config.map(r => ({ key: (r.key || r.Key || "").trim(), value: (r.value || r.Value || "") })).filter(x => x.key);
      DATA.rules = HandicapRules;

      // handicap lookup
      adjLookup = new Map();
      for (const r of HandicapRules) {
        const band = Number(r.band || r.Band);
        const score = Number(r.score || r.Score);
        const adj = Number(r.adjustment || r.Adjustment);
        if (Number.isFinite(band) && Number.isFinite(score) && Number.isFinite(adj)) {
          adjLookup.set(`${band}:${Math.trunc(score)}`, adj);
        }
      }

      setStatus("Loaded ✅", `Members ${DATA.members.length} · Rounds ${DATA.rounds.length}`);
      render();
    }

    // events
    window.addEventListener("hashchange", showPage);
    document.querySelectorAll(".navLink").forEach(a => a.addEventListener("click", () => setTimeout(showPage, 0)));

    $("btnRefresh").addEventListener("click", () => syncAll().catch(err => setStatus("Error ❌", String(err))));
    $("searchBox").addEventListener("input", render);
    $("btnReset").addEventListener("click", () => { $("searchBox").value=""; render(); });

    // modal events
    $("mmClose").addEventListener("click", closeMemberModal);
    $("memberModal").addEventListener("click", (e) => {
      if (e.target === $("memberModal")) closeMemberModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !$("memberModal").classList.contains("hidden")) closeMemberModal();
    });

    // Boot
    setStatus("Ready", "Loading…");
    syncAll().catch(err => setStatus("Error ❌", String(err)));
  </script>
</body>
</html>
